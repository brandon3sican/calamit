{% extends 'dashboard-layout/base.html' %}
{% load static %}

{% block content %}
<main id="main" class="main">
    <div class="pagetitle">
        <h1>Thresholds</h1>
        <!-- Breadcrumb-->
        <nav>
            <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'dashboard-home'%}">Home</a></li>
            <li class="breadcrumb-item">Thresholds</li>
            <li class="breadcrumb-item active">List</li>
            </ol>
        </nav><!-- End Breadcrumb-->
    </div>

    <section class="section">

      {% if form.non_field_errors %}
    <div class="alert alert-danger col-md-4" role="alert">
        {% for error in form.non_field_errors %}
            {{ error }}
        {% endfor %}
    </div>
{% endif %}

<form class="row g-3" method="post" novalidate>
    {% csrf_token %}
    <div class="col-md-4">
    {% for field in form %}
        <div class="mb-1">
            <label class="form-label" for="{{ field.auto_id }}">{{ field.label }}</label>
            {{ field }}
            {% for error in field.errors %}
            <div class="invalid-feedback">
                    {{ error }}
            </div>
            {% endfor %}
        </div>
    {% endfor %}
    </div>
    <button type="submit" class="btn btn-primary">Submit</button>
</form>
      <!-- Add Modal (Threshold) -->
      <div class="modal fade" id="add_modal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Add Threshold</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <!-- Add Form (Threshold) -->
            <form class="row g-3" id="add_form">
            <div class="modal-body">
              <div class="col-md-12">
                <label for="parameter" class="form-label">Parameter</label>
                <select class="form-select" name="parameter">
                  <option>--Select--</option>
                    {% for parameter in parameters %}
                      <option value="{{parameter.id}}">{{parameter.parameter_name}}</option>
                    {% endfor %}

                    {% for id, obj in leads.SOURCE %}
                      <option value="{{ id }}" {% if leads.source == id %} selected="selected"{% endif %}>{{ obj }}</option>
                    {% endfor %}
                </select>
              </div>
              <div class="col-md-12">
                <label for="lower_limit" class="form-label">Lower Limit</label>
                <input type="number" class="form-control" step=0.01 name="lower_limit">
              </div>
              <div class="col-md-12">
                <label for="upper_limit" class="form-label">Upper Limit</label>
                <input type="number" class="form-control" step=0.01 name="upper_limit">
              </div>
              <div class="col-md-12">
                <label for="description" class="form-label">Description</label>
                <input type="text" class="form-control" name="description">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button class="btn btn-primary" type="submit">Submit</button>
            </div>
            </form><!-- End Add Form (Threshold) -->
          </div>
        </div>
      </div><!-- End Add Modal (Threshold)-->

      <!-- Edit Modal (Threshold) -->
      <div class="modal fade" id="edit_modal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Edit Threshold</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <!-- Edit Form (Threshold) -->
            <form class="row g-3" id="edit_form">
            <div class="modal-body">
              <div class="col-md-12">
                <input type="text" class="form-control" name="id" id="id">
              </div>
              <div class="col-md-12">
                <label for="parameter" class="form-label">Parameter</label>
                <select class="form-select" name="parameter" id="parameter">
                  <option>--Select--</option>
                    {% for parameter in parameters %}
                      <option value="{{parameter.id}}">{{parameter.parameter_name}}</option>
                    {% endfor %}
                </select>
              </div>
              <div class="col-md-12">
                <label for="lower_limit" class="form-label">Lower Limit</label>
                <input type="number" class="form-control" step=0.01 name="lower_limit" id="lower_limit">
              </div>
              <div class="col-md-12">
                <label for="upper_limit" class="form-label">Upper Limit</label>
                <input type="number" class="form-control" step=0.01 name="upper_limit" id="upper_limit">
              </div>
              <div class="col-md-12">
                <label for="description" class="form-label">Description</label>
                <input type="text" class="form-control" name="description" id="description">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button class="btn btn-primary" type="submit">Save changes</button>
            </div>
            </form><!-- End Edit Form (Parameters) -->
          </div>
        </div>
      </div><!-- End Edit Modal (Parameters)-->

      
      <div class="row">
        <div class="col-lg-12">
        <div class="card">
            <div class="card-body">
              <h5 class="card-title">Thresholds &nbsp&nbsp
              <i class="bi bi-plus-circle-fill text-success" type="button" data-bs-toggle="modal" data-bs-target="#add_modal"></i></h5>
              <!-- List of Soil Parameters -->
              <table class="table table-hover" id="threshold_table">
                <thead>
                  <tr>
                    <th scope="col">Parameter</th>
                    <th scope="col">Lower Limit</th>
                    <th scope="col">Upper Limit</th>
                    <th scope="col">Description</th>
                    <th scope="col">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for threshold in thresholds %}
                    <tr id="threshold-{{threshold.id}}">
                        <td class="thresholdParameter thresholdData" name="parameter">{{threshold.parameter.parameter_name}}</td>
                        <td class="thresholdLowerLimit thresholdData" name="lower_limit">{{threshold.lower_limit}}</td>
                        <td class="thresholdUpperLimit thresholdData" name="upper_limit">{{threshold.upper_limit}}</td>
                        <td class="thresholdDescription thresholdData" name="description">{{threshold.description}}</td>
                        <td>
                            <i class="bi bi-pencil-fill text-primary" type="button" onClick="editThreshold({{threshold.id}})" data-bs-toggle="modal" data-bs-target="#edit_modal"></i> &nbsp
                            <i class="bi bi-trash-fill text-warning" onClick="deleteThreshold({{threshold.id}})" type="button"></i>
                        </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
              <!-- End List of Soil Parameters -->
              
              {% comment %} <!-- Pagination -->
              {% if page_obj.has_other_pages %}
                <ul class="pagination">
                  <!-- Go to Previous Page -->
                  {% if page_obj.has_previous %}
                    <li class="page-item">
                      <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>
                    </li>
                  {% else %}
                    <li class="page-item disabled"><a class="page-link"><span aria-hidden="true">&laquo;</span></a></li>
                  {% endif %} 

                  <!-- Page Numbers -->
                  {% for page_number in paginator.page_range %}
                    {% if page_number == page_obj.number %}
                      <li class="page-item active" aria-current="page">
                        <a class="page-link" href="?page={{ page_number }}">{{ page_number }}</a>
                      </li>
                    {% else %}
                      <li class="page-item"><a class="page-link" href="?page={{ page_number }}">{{ page_number }}</a></li>
                    {% endif %}
                  {% endfor %}

                  <!-- Go to Next Page -->
                  {% if page_obj.has_next %}
                    <li class="page-item">
                      <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Next"><span aria-hidden="true">&raquo;</a>
                    </li>
                  {% else %}
                    <li class="page-item disabled"><a class="page-link"><span aria-hidden="true">&raquo;</span></a></li>
                  {% endif %}
                </ul>
              {% endif %}
              <!-- End of Pagination --> {% endcomment %}
            </div>

          </div>
        </div>


      </div>
    </section>
</main>
{% endblock content %}

{% block javascript %}
<script>
//create and store
$("#add_form").on('submit',function(e) {
    e.preventDefault();
    
    var parameterInput = $('select[name="parameter"]').val();
    var lower_limitInput = $('input[name="lower_limit"]').val().trim();
    var upper_limitInput = $('input[name="upper_limit"]').val().trim();
    var description = $('input[name="description"]').val().trim();

    //console.log(parameterInput + " " + lower_limitInput + " " + upper_limitInput + " " + description)
    if (parameterInput && lower_limitInput && upper_limitInput && description) {
        $.ajax({
            url: '{% url "threshold-create" %}',
            data: {
                'parameter': parameterInput,
                'lower_limit': lower_limitInput,
                'upper_limit': upper_limitInput,
                'description': description
            },
            dataType: 'json',
            success: function (data) {
              console.log(data)
              if (data) {
                appendToThresholdList(data.threshold, data.parameter);
                swal({
                  title: "Success!",
                  text: "Record has been added successfully!",
                  icon: "success",
                  button: "OK",
                });
              }
            },
            error: function(data){
              swal({
                  title: "Error!",
                  text:  "An error occured, unable to add inputted data!",
                  icon: "error",
                  button: "OK",
              });
            } 
        }); 
      } else {
        swal({
          title: "Error!",
          text:  "All fields must have a valid value.",
          icon: "error",
          button: "OK",
        });
    }
    $('#add_form').trigger("reset");
    $('#add_modal').modal('hide');
});

//display created/stored data
function appendToThresholdList(threshold, parameter) {
  $("#threshold_table > tbody").prepend(`
        <tr id="threshold-${threshold.id}">
          <td class="thresholdParameter thresholdData" name="parameter">${parameter.parameter_name}</td>
          <td class="thresholdLowerLimit thresholdData" name="lower_limit">${threshold.lower_limit}</td>
          <td class="thresholdUpperLimit thresholdData" name="upper_limit">${threshold.upper_limit}</td>
          <td class="thresholdDescription thresholdData" name="description">${threshold.description}</td>
          <td>
            <i class="bi bi-pencil-fill text-primary" type="button" onClick="editThreshold(${threshold.id})" data-bs-toggle="modal" data-bs-target="#edit_modal"></i> &nbsp
            <i class="bi bi-trash-fill text-warning" onClick="deleteThreshold(${threshold.id})" type="button"></i>
          </td>
        </tr>
    `);
}

//edit
function editThreshold(id) {
  if (id) {
    tr_id = "#threshold-" + id;
    parameter = $(tr_id).find(".thresholdParameter").text();
    lower_limit = $(tr_id).find(".thresholdLowerLimit").text();
    upper_limit = $(tr_id).find(".thresholdUpperLimit").text();
    description = $(tr_id).find(".thresholdDescription").text();
    console.log(tr_id + " " +  parameter + " " + lower_limit)
    $('#id').val(id);
    $('#parameter').val(parameter);
    $('#lower_limit').val(lower_limit);
    $('#upper_limit').val(upper_limit);
    $('#description').val(description);
  }
}

</script>
{% endblock javascript %}